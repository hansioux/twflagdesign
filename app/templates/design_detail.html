{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 3rem; align-items: start; margin-bottom: 3rem;">

        <!-- Left Column: Image and Info -->
        <div>
            <div class="card" style="overflow: hidden; margin-bottom: 2rem;">
                <div
                    style="background: var(--color-border); padding: 2rem; display: flex; justify-content: center; align-items: center;">
                    <img src="{{ url_for('static', filename='uploads/' + design.image_filename) }}"
                        alt="{{ design.title }}"
                        style="max-width: 100%; max-height: 500px; box-shadow: var(--shadow-lg);">
                </div>
                <div style="padding: 2rem;">
                    <h1 style="font-family: var(--font-heading); font-size: 2rem; margin-bottom: 0.5rem;">{{
                        design.title }}</h1>
                    <div
                        style="color: var(--color-text-muted); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                        <span>By {{ design.author.name }}</span>
                        <span>&bull;</span>
                        <span>{{ design.created_at.strftime('%B %d, %Y') }}</span>
                    </div>

                    {% if design.hashtags %}
                    <div style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        {% for tag in design.hashtags.split() %}
                        <a href="{{ url_for('main.index', q=tag) }}"
                            style="color: var(--color-accent); font-size: 0.875rem; text-decoration: none; padding: 0.25rem 0.5rem; background: #e0f2fe; border-radius: 999px;">
                            {{ tag }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Description & Symbolism</h3>
                    <p style="line-height: 1.7; color: var(--color-text-main); white-space: pre-wrap;">{{
                        design.description | format_content }}</p>

                    {% if current_user.is_authenticated and (current_user == design.author or current_user.is_admin) %}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('main.edit_design', public_id=design.public_id) }}" class="btn"
                            style="padding: 0.5rem 1rem; border: 1px solid var(--color-border); font-size: 0.875rem;">Edit
                            Design</a>
                        <a href="{{ url_for('main.delete_design', public_id=design.public_id) }}" class="btn"
                            style="padding: 0.5rem 1rem; border: 1px solid #fee2e2; background: #fee2e2; color: #dc2626; font-size: 0.875rem; text-decoration: none;">Delete</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Rating -->
        <div>
            <div class="card" style="padding: 1.5rem; position: sticky; top: 6rem;">
                <h3 style="font-family: var(--font-heading); font-size: 1.25rem; margin-bottom: 1.5rem;">Rate this
                    Design</h3>

                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span>Average Rating</span>
                    <span style="font-weight: 700; color: var(--color-accent);">{{ avg_rating }} / 10</span>
                </div>

                {% if current_user.is_authenticated %}
                <form method="POST">
                    <div
                        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        {% for i in range(1, 11) %}
                        {% if i == 6 %} </div>
                    <div
                        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        {% endif %}
                        <button type="submit" name="rating_value" value="{{ i }}" class="btn"
                            style="padding: 0.5rem; border: 1px solid var(--color-border); font-size: 0.875rem; {{ 'background-color: var(--color-accent); color: white;' if user_rating == i else 'background: var(--color-background); color: var(--color-text-main);' }}">
                            {{ i }}
                        </button>
                        {% endfor %}
                    </div>
                    <p style="font-size: 0.8rem; color: var(--color-text-muted); text-align: center;">Click a number to
                        rate</p>
                </form>
                {% else %}
                <p style="color: var(--color-text-muted); font-size: 0.875rem;">Login to rate this design.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Bottom Section: Comments -->
    <div>
        <h3 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 1.5rem;">Community Feedback ({{
            design.comments|length }})</h3>

        {% for comment in design.comments %}
        <div style="border-bottom: 1px solid var(--color-border); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                <img src="{{ comment.author.profile_pic or 'https://via.placeholder.com/32' }}" alt=""
                    style="width: 32px; height: 32px; border-radius: 50%;">
                <div>
                    <div style="font-weight: 500;">{{ comment.author.name }}</div>
                    <div style="display: flex; gap: 0.5rem; align-items: baseline;">
                        <div style="font-size: 0.8rem; color: var(--color-text-muted);">{{
                            comment.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                        {% if current_user.is_authenticated and (current_user == comment.author or
                        current_user.is_admin) %}
                        <a href="{{ url_for('main.edit_comment', comment_id=comment.id) }}"
                            style="font-size: 0.8rem; color: var(--color-accent);">Edit</a>
                        <a href="{{ url_for('main.delete_comment', comment_id=comment.id) }}"
                            style="color: #dc2626; font-size: 0.8rem; text-decoration: underline;">Delete</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <p style="color: var(--color-text-main); white-space: pre-wrap;">{{ comment.content | format_content }}</p>
        </div>
        {% endfor %}

        {% if current_user.is_authenticated %}
        <form method="POST" style="margin-top: 2rem;">
            <h4 style="margin-bottom: 0.5rem;">Leave a Comment</h4>
            <textarea name="comment_content" rows="3" required
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-background); margin-bottom: 1rem;"
                placeholder="Share your thoughts constructively..."></textarea>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
        {% else %}
        <div
            style="background: var(--color-surface); padding: 1.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); text-align: center;">
            Please <a href="{{ url_for('auth.login') }}" style="color: var(--color-accent); font-weight: 600;">login</a>
            to join the discussion.
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}